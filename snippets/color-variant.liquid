{% comment %}Split the filtered colors entered by the user and prepare them for comparison{% endcomment %}
{% assign color_option_exists = false %}
{% assign rendered_variants = '' %}

{% comment %}Identify the color option index{% endcomment %}
{% for option in product.options_with_values %}
  {% if option.name == 'Color' or option.name == 'Farbe' %}
    {% assign color_option_exists = true %}
    {% assign color_index = forloop.index0 %}
    {% break %}
  {% endif %}
{% endfor %}

{% comment %}Process filtered colors if filtering is enabled{% endcomment %}
{% if enable_color_filter %}
  {% assign filtered_colors_array = filtered_colors | default: 'Sand' | split: ',' | map: 'strip' | map: 'downcase' %}
{% endif %}

{% comment %}Render products based on color variants or default to normal product card{% endcomment %}
{% if color_option_exists %}
  {% assign color_variants_rendered = false %}

  {% for variant in product.variants %}
    {% if variant.available %}
      {% assign current_color = variant.options[color_index] | strip | downcase %}

      {% unless rendered_variants contains current_color %}
        {% assign should_render_variant = true %}

        {% if enable_color_filter %}
          {% unless filtered_colors_array contains current_color %}
            {% assign should_render_variant = false %}
          {% endunless %}
        {% endif %}

        {% if should_render_variant %}
          {% render 'color-product-card',
            variant_sel: variant,
            product: product,
            reveal: reveal,
            hide_product_information: hide_product_information,
            stacked: true,
            colorname: current_color,
            tabs2: tabs2
          %}
          {% assign rendered_variants = rendered_variants | append: current_color | append: ',' %}
          {% assign color_variants_rendered = true %}
        {% endif %}
      {% endunless %}
    {% endif %}
  {% endfor %}

  {% unless color_variants_rendered %}
    {% comment %}No variants were rendered, render the product normally{% endcomment %}
    {% render 'product-card',
      product: product,
      reveal: reveal,
      hide_product_information: hide_product_information,
      stacked: true
    %}
  {% endunless %}

{% else %}
  {% comment %}Product does not have color option, render normally{% endcomment %}
  {% render 'product-card',
    product: product,
    reveal: reveal,
    hide_product_information: hide_product_information,
    stacked: true
  %}
{% endif %}