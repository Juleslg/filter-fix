{% assign color_active = false %}
{% assign rendered_variants = '' %}

{% for option in product.options %}
  {% if option == 'Color' or option == 'Farbe' %}
    {% assign color_active = true %}
    {% assign color_index = forloop.index0 %}
    {% break %}
  {% endif %}
{% if option == 'Color' or option == 'Farbe' %}
{% assign color_active = true %}
{% endif %}
{% endfor %}
{% if product.variants.size > 1 and color_active == true %}
{% for option in product.options %}
{% if option == 'Color' or option == 'Farbe' %}
{% assign index = forloop.index0 %}
{% assign colorlist = '' %}
{% assign color = '' %}
{% for variant in product.variants %}
{% if variant.available and variant.inventory_quantity >= 8 %} <!-- Check if variant is in stock -->
{% capture color %}
{{ variant.options[index] }}
{% endcapture %}

{% if product.variants.size > 1 and color_active %}
  {% for variant in product.variants %}
    {% if variant.available and variant.inventory_quantity >= 8 %}
      {% assign current_color = variant.options[color_index] | strip | downcase %}
      
      {% unless rendered_variants contains current_color %}
        {% if current_color contains 'sand' %}
          {% render 'color-product-card', 
            variant_sel: variant,
            product: product,
            reveal: reveal, 
            hide_product_information: hide_product_information, 
            stacked: true,
            colorname: current_color,
            tabs2: tabs2
          %}
          {% assign rendered_variants = rendered_variants | append: current_color | append: ',' %}
        {% endif %}
      {% endunless %}
    {% endif %}
  {% endfor %}
{% unless colorlist contains color %}
{% assign lazy_load = false %}
{%- if forloop.index > 2 -%}
{%- assign lazy_load = true -%}
{%- endif -%}
{% render 'color-product-card', 
variant_sel: variant,
product: product,
reveal: reveal, 
hide_product_information: hide_product_information, 
stacked: true,
colorname: color,
tabs2: tabs2
%}
          {%- render 'price-list', product: product, variant: variant_sel, variant_collection: true, context: 'card' -%}
          
{% capture tempList %}
{{colorlist | append: color | append: " " }}
{% endcapture %}
{% assign colorlist = tempList %}
{% endunless %}
{% endif %}  <!-- End of in-stock check -->
{% endfor %}
{% endif %}
{% endfor %}
{% else %}
  {% render 'product-card',
    product: product,
    reveal: reveal, 
    hide_product_information: hide_product_information,
    stacked: true
  %}
{% endif %}
{% render 'product-card',
product: product,
reveal: reveal, 
hide_product_information: hide_product_information,
stacked: true
%}