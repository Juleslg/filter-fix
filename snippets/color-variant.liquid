{% assign color_active = false %}
{% assign rendered_variants = '' %}

{% for option in product.options %}
  {% if option == 'Color' or option == 'Farbe' %}
    {% assign color_active = true %}
    {% assign color_index = forloop.index0 %}
    {% break %}
  {% endif %}
{% endfor %}

{% if product.variants.size > 1 and color_active %}
  {% assign should_filter_colors = section.settings.enable_color_filter %}
  {% assign filtered_colors = section.settings.filtered_colors | split: ',' | map: 'strip' | map: 'downcase' %}
  
  {% for variant in product.variants %}
    {% if variant.available and variant.inventory_quantity >= 8 %}
      {% assign current_color = variant.options[color_index] | strip | downcase %}
      
      {% unless rendered_variants contains current_color %}
        {% assign should_show = true %}
        
        {% if should_filter_colors %}
          {% assign should_show = false %}
          {% if filtered_colors contains current_color %}
            {% assign should_show = true %}
          {% endif %}
        {% endif %}

        {% if should_show %}
          {% render 'color-product-card', 
            variant_sel: variant,
            product: product,
            reveal: reveal, 
            hide_product_information: hide_product_information, 
            stacked: true,
            colorname: current_color,
            tabs2: tabs2
          %}
          {% assign rendered_variants = rendered_variants | append: current_color | append: ',' %}
        {% endif %}
      {% endunless %}
    {% endif %}
  {% endfor %}
{% else %}
  {% render 'product-card',
    product: product,
    reveal: reveal, 
    hide_product_information: hide_product_information,
    stacked: true
  %}
{% endif %}